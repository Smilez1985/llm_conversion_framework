#!/bin/bash
# config_module.sh for [MODULE_NAME]
# Generated by LLM Cross-Compiler Framework
# ZWECK: Generiert die CMake Toolchain basierend auf Hardware-Probe.
# SECURITY: Uses quoted heredocs to prevent shell injection from user flags.

set -euo pipefail

# Environment & Paths
BUILD_CACHE_DIR="${BUILD_CACHE_DIR:-/build-cache}"
HARDWARE_CONFIG="${BUILD_CACHE_DIR}/target_hardware_config.txt"
CMAKE_TOOLCHAIN="${BUILD_CACHE_DIR}/cross_compile_toolchain.cmake"

log() { echo ">> [Config] $1"; }

# 1. Load Hardware Config (Source of Truth)
if [ -f "$HARDWARE_CONFIG" ]; then
    log "Loading hardware profile from $HARDWARE_CONFIG..."
    # SECURITY: Validierung der Keys auf A-Z_ um Code Execution via eval/declare zu verhindern
    # Wir lesen nur Zeilen, die wie KEY=VALUE aussehen
    while IFS='=' read -r key value; do
        if [[ $key =~ ^[A-Z0-9_]+$ ]]; then
            # Entferne eventuelle Windows CR Zeichen
            value=$(echo "$value" | tr -d '\r')
            declare "$key"="$value"
        fi
    done < <(grep '=' "$HARDWARE_CONFIG")
fi

# 2. Generate CMake Toolchain
log "Generating CMake toolchain for [IHRE_ARCHITEKTUR]..."

# SECURITY CRITICAL:
# Use 'EOF' (quoted) to prevent shell expansion of variables like [CPU_FLAGS] immediately.
# This ensures that whatever is in the flags is written literally to the cmake file,
# and not executed/expanded by the shell during generation.
cat <<'EOF' > "$CMAKE_TOOLCHAIN"
# Generated CMake Toolchain via LLM Framework
SET(CMAKE_SYSTEM_NAME Linux)
SET(CMAKE_SYSTEM_PROCESSOR [IHRE_ARCHITEKTUR])

# --- COMPILER FLAGS (From Wizard/Template) ---
# Note: These are injected literally by the generator
SET(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} [CPU_FLAGS]")
SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} [CPU_FLAGS]")

# --- AUTO-DETECTED OPTIMIZATIONS ---
EOF

# 3. Dynamic Feature Flags (Based on Probe SUPPORTS_*)
# These checks are safe because they are boolean checks controlled by our script logic.

# NEON (ARM)
if [ "${SUPPORTS_NEON:-OFF}" == "ON" ]; then
    echo 'ADD_DEFINITIONS(-DGGML_NEON=ON)' >> "$CMAKE_TOOLCHAIN"
    log "Auto-Enabled: NEON"
fi

# FP16 (ARM/x86)
if [ "${SUPPORTS_FP16:-OFF}" == "ON" ]; then
    echo 'ADD_DEFINITIONS(-DGGML_FP16=ON)' >> "$CMAKE_TOOLCHAIN"
    log "Auto-Enabled: FP16"
fi

# AVX2 (x86)
if [ "${SUPPORTS_AVX2:-OFF}" == "ON" ]; then
    echo 'ADD_DEFINITIONS(-DGGML_AVX2=ON)' >> "$CMAKE_TOOLCHAIN"
    log "Auto-Enabled: AVX2"
fi

# AVX512 (x86)
if [ "${SUPPORTS_AVX512:-OFF}" == "ON" ]; then
    echo 'ADD_DEFINITIONS(-DGGML_AVX512=ON)' >> "$CMAKE_TOOLCHAIN"
    log "Auto-Enabled: AVX512"
fi

# CUDA (NVIDIA)
if [ "${SUPPORTS_CUDA:-OFF}" == "ON" ]; then
    echo 'ADD_DEFINITIONS(-DGGML_CUDA=ON)' >> "$CMAKE_TOOLCHAIN"
    log "Auto-Enabled: CUDA"
fi

# RKNN / NPU Support (Generic Flag)
if [ "${SUPPORTS_RKNN:-OFF}" == "ON" ]; then
    echo 'ADD_DEFINITIONS(-DGGML_RKNN=ON)' >> "$CMAKE_TOOLCHAIN"
    log "Auto-Enabled: RKNN (NPU)"
fi

# 4. Custom CMake Flags from Wizard
# SECURITY: Use quoted heredoc again for user input part
cat <<'EOF' >> "$CMAKE_TOOLCHAIN"

# --- CUSTOM FLAGS (User Provided) ---
[CMAKE_FLAGS]
EOF

log "Toolchain generated at $CMAKE_TOOLCHAIN"

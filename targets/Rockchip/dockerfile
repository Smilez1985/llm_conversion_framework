# Dockerfile for Rockchip RK3588/RK3566
# Generated by LLM Cross-Compiler Framework
# Target Architecture: aarch64 (Cross-Compile on x64 Host)

FROM debian:bookworm-slim AS builder

LABEL maintainer="Community Contributor"
LABEL description="Target for Rockchip RK3588/RK3566"
LABEL target.architecture="aarch64"

# CI Args for User Mapping
ARG USER_ID=1000
ARG GROUP_ID=1000

ENV DEBIAN_FRONTEND=noninteractive
ENV LLAMA_CPP_PATH=/usr/src/llama.cpp
ENV BUILD_CACHE_DIR=/build-cache

# System Dependencies
# FIX: Added Cross-Compilers (gcc-aarch64-linux-gnu, g++-aarch64-linux-gnu)
RUN apt-get update && apt-get install -y --no-install-recommends \
        build-essential cmake git git-lfs python3-pip \
        python3-dev python3-venv pkg-config libffi-dev \
        ca-certificates curl wget \
        gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
    && rm -rf /var/lib/apt/lists/*

# Python Environment Setup
RUN python3 -m pip install --no-cache-dir --upgrade pip setuptools wheel

# Install CPU-only PyTorch to save space (Builder runs on Host CPU)
RUN python3 -m pip install --no-cache-dir \
        torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu

# Install Framework Dependencies
RUN python3 -m pip install --no-cache-dir \
        transformers tokenizers safetensors sentencepiece protobuf \
        huggingface-hub datasets numpy scipy onnx onnxruntime \
        tqdm psutil pyyaml requests

# ============================================================================
# OFFICIAL SDK INSTALLATION (Fallback / Base Layer)
# Installs wheels directly from Rockchip Repositories
# ============================================================================
WORKDIR /tmp

# 1. RKLLM-Toolkit (for LLM on RK3588)
# Using tag 'release-v1.2.1b1' as stable fallback source
RUN git clone -b release-v1.2.1b1 https://github.com/airockchip/rknn-llm.git && \
    # Find and install the python 3.11 wheel (Debian Bookworm uses py3.11)
    # Pattern: rkllm_toolkit-*-cp311-cp311-linux_x86_64.whl
    pip install --no-cache-dir rknn-llm/rkllm-toolkit/packages/rkllm_toolkit-*-cp311-cp311-linux_x86_64.whl && \
    rm -rf rknn-llm

# 2. RKNN-Toolkit2 (for Vision/Voice on RK3566/RK3588)
# Using tag 'v2.0.0-beta0'
RUN git clone -b v2.0.0-beta0 https://github.com/airockchip/rknn-toolkit2.git && \
    pip install --no-cache-dir rknn-toolkit2/rknn-toolkit2/packages/rknn_toolkit2-*-cp311-cp311-linux_x86_64.whl && \
    rm -rf rknn-toolkit2

# Verification (Fails build if installation broke)
RUN python3 -c "from rkllm.api import RKLLM; print('✅ RKLLM Module installed')"
RUN python3 -c "from rknn.api import RKNN; print('✅ RKNN Module installed')"

# ============================================================================

# Copy framework modules
WORKDIR /app
COPY modules/ ./modules/
COPY scripts/ ./scripts/
RUN chmod +x modules/*.sh scripts/*.py

# Set working directory & User
WORKDIR ${BUILD_CACHE_DIR}

# Create User mapping host UID/GID
RUN groupadd -g ${GROUP_ID} llmbuilder && \
    useradd -u ${USER_ID} -g llmbuilder -d /app -s /bin/bash llmbuilder && \
    chown -R llmbuilder:llmbuilder /app

# Default entrypoint
COPY docker/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

USER llmbuilder
ENTRYPOINT ["/entrypoint.sh"]
CMD ["interactive"]

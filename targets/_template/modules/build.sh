#!/bin/bash
# build.sh - Master Build Dispatcher for [MODULE_NAME]
# Generated by LLM Cross-Compiler Framework
#
# Decides which build backend to use based on Task and Hardware capabilities.

set -euo pipefail

WORK_DIR="${BUILD_CACHE_DIR:-/build-cache}"
OUTPUT_DIR="${WORK_DIR}/output"
mkdir -p "$OUTPUT_DIR"

# Inputs injected by Orchestrator
TASK="${MODEL_TASK:-LLM}"           # LLM, VOICE, VLM
QUANT="${QUANTIZATION:-FP16}"
MODEL_SOURCE="${MODEL_SOURCE}"

echo "=== Build Dispatcher ==="
echo "Target:     [MODULE_NAME]"
echo "Task Type:  $TASK"
echo "Quant Mode: $QUANT"

# Helper to check if a script exists and run it
run_module() {
    local script="$1"
    if [ -f "$script" ]; then
        chmod +x "$script"
        "$script"
    else
        echo "âŒ Error: Module script '$script' not found!"
        exit 1
    fi
}

# --- DISPATCH LOGIC (Template Slot) ---
# [QUANTIZATION_LOGIC]

# Default Fallback if [QUANTIZATION_LOGIC] is empty or doesn't exit
echo ">> No specific logic matched. Running default CPU conversion..."

# Standard GGUF (CPU) Conversion as absolute fallback
if [ -f "/app/modules/convert_module.sh" ]; then
    /app/modules/convert_module.sh
else
    echo "Error: No conversion module found."
    exit 1
fi

# --- PACKAGING ---
echo "=== Packaging Artifacts ==="
cd "$OUTPUT_DIR" || exit 1
tar -czf "deployment_[MODULE_NAME]_${TASK}.tar.gz" ./*
echo "Build completed successfully."

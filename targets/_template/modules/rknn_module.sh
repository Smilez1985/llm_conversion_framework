#!/bin/bash
# rknn_module.sh Template
# Generated by LLM Cross-Compiler Framework
# ZWECK: Vorlage für RKNN-Toolkit2 Integration.
# Installiert automatisch das passende Python-Wheel.

set -euo pipefail

MODEL_SOURCE="${MODEL_SOURCE:-}"
QUANTIZATION="${QUANTIZATION:-i8}"
BUILD_CACHE_DIR="${BUILD_CACHE_DIR:-/build-cache}"
OUTPUT_DIR="${OUTPUT_DIR:-${BUILD_CACHE_DIR}/output}"
SCRIPT_DIR="/app/scripts"
RKNN_TOOLKIT_DIR="/app/rknn-toolkit2"

log() { echo ">> [RKNN-Template] $1"; }
die() { echo "❌ [RKNN-Template] $1" >&2; exit 1; }

ensure_rknn_installed() {
    if python3 -c "import rknn.api" &> /dev/null; then return 0; fi
    
    log "Installing RKNN..."
    PY_VER=$(python3 -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")
    
    # Smart search for wheel matching python version
    WHEEL=$(find "$RKNN_TOOLKIT_DIR/packages" -name "rknn_toolkit2*${PY_VER}*.whl" | head -n 1)
    
    if [[ -n "$WHEEL" ]]; then
        # FIX: Use python3 -m pip
        python3 -m pip install "$WHEEL" || die "Install failed"
    else
        log "⚠️  Warning: No matching wheel found for $PY_VER. Assuming pre-installed."
    fi
}

main() {
    log "Initializing..."
    
    if [[ "$MODEL_SOURCE" == "none" ]]; then exit 0; fi

    # Quant Map
    case "${QUANTIZATION:-i8}" in
        "INT8"|"i8"|"Q8_0") Q_TYPE="i8";;
        *) Q_TYPE="fp16";;
    esac

    # Setup
    if [ ! -d "$RKNN_TOOLKIT_DIR" ]; then
        # In template, we assume it might be mounted or cloned here
        log "Toolkit dir missing, cloning default..."
        git clone "https://github.com/airockchip/rknn-toolkit2.git" "$RKNN_TOOLKIT_DIR"
    fi
    
    ensure_rknn_installed

    # Execute
    CONVERTER="$SCRIPT_DIR/rknn_converter.py"
    if [ ! -f "$CONVERTER" ]; then die "Converter missing."; fi
    
    # Dummy call for template
    # python3 "$CONVERTER" ...
    
    log "Template execution finished."
}

main "$@"

# Dockerfile für die Radxa Rockchip Familie (AArch64/NEON)
# DIREKTIVE: Goldstandard, Multi-stage, Hadolint-konform, Secured

# ============================================================================
# STAGE 1: Build Environment Setup
# ============================================================================
FROM debian:bookworm-slim AS builder

# Metadata
LABEL maintainer="LLM Cross-Compiler Framework"
LABEL description="Rockchip Family Cross-Compilation Container"

# Build arguments (Werden von docker-compose aus project_sources.yml befüllt)
ARG PYTHON_VERSION=3.11
ARG POETRY_URL="https://install.python-poetry.org"
# Hash muss beim Build übergeben werden oder hardcoded als Fallback sicher sein
ARG POETRY_SHA256="3b5842cd6318176812455429c6c109909d21b184579720f154506f6734828455" 

ENV DEBIAN_FRONTEND=noninteractive
ENV BUILD_CACHE_DIR=/build-cache
ENV CCACHE_DIR=/build-cache/ccache
ENV PATH="/root/.local/bin:$PATH"

# System Dependencies & Security Tools
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        build-essential cmake make git curl wget ca-certificates \
        # Cross-Compiler
        crossbuild-essential-arm64 \
        gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
        # Python
        python3=${PYTHON_VERSION}* python3-pip python3-dev python3-venv \
        # Utils & Security
        pkg-config libffi-dev libssl-dev jq bc file time \
        ccache \
    && rm -rf /var/lib/apt/lists/*

# ============================================================================
# SECURE POETRY INSTALLATION
# ============================================================================
# Kein 'curl | python'! Download -> Verify -> Install
RUN curl -sSL -o poetry_installer.py "${POETRY_URL}" \
    && echo "${POETRY_SHA256}  poetry_installer.py" | sha256sum -c - \
    && python3 poetry_installer.py \
    && rm poetry_installer.py

# Configure Poetry
ENV PATH="/root/.local/bin:$PATH"
RUN poetry config virtualenvs.create false

# ============================================================================
# DEPENDENCIES
# ============================================================================
# Installiere Python Pakete mit Version Pinning
RUN python3 -m pip install --no-cache-dir --upgrade pip setuptools wheel && \
    python3 -m pip install --no-cache-dir \
    torch==2.1.2 torchvision==0.16.2 --index-url https://download.pytorch.org/whl/cpu \
    transformers==4.36.2 safetensors==0.4.0 numpy==1.24.4 pyyaml requests tqdm

# ============================================================================
# FRAMEWORK MODULES INTEGRATION
# ============================================================================

WORKDIR /app
COPY modules/ ./modules/
COPY scripts/ ./scripts/
RUN chmod +x modules/*.sh scripts/*.sh

# ============================================================================
# STAGE 2: Runtime Environment
# ============================================================================
FROM debian:bookworm-slim AS runtime

LABEL stage="runtime"
LABEL framework="llm-cross-compiler"
LABEL target="rockchip"

ENV DEBIAN_FRONTEND=noninteractive
ENV LLAMA_CPP_PATH=/usr/src/llama.cpp
ENV BUILD_CACHE_DIR=/build-cache
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PATH="/app/modules:/app/scripts:${PATH}"

# Runtime dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        crossbuild-essential-arm64 \
        gcc-aarch64-linux-gnu \
        g++-aarch64-linux-gnu \
        python3 python3-pip \
        cmake make git bc jq file curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Copy Python environment from builder
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

# Copy framework modules
COPY --from=builder /app /app

# Runtime Config
RUN mkdir -p ${BUILD_CACHE_DIR} \
    && mkdir -p ${BUILD_CACHE_DIR}/{models,temp,output,logs,toolchains} \
    && chmod -R 755 ${BUILD_CACHE_DIR}

RUN groupadd -r llmbuilder && \
    useradd -r -g llmbuilder -d /app -s /bin/bash llmbuilder \
    && chown -R llmbuilder:llmbuilder /app ${BUILD_CACHE_DIR}

# KORREKTUR: Entrypoint liegt im Root, nicht in /docker
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

WORKDIR ${BUILD_CACHE_DIR}
USER llmbuilder

VOLUME ["${BUILD_CACHE_DIR}"]
ENTRYPOINT ["/entrypoint.sh"]
CMD ["interactive"]

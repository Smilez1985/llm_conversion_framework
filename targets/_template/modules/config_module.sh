#!/bin/bash
# config_module.sh - Hardware Config & CMake Toolchain Generator
# Part of LLM Cross-Compiler Framework
#
# DIREKTIVE: Goldstandard, vollständig, professionell geschrieben.
# ZWECK: Liest target_hardware_config.txt und generiert optimierte Build-Konfiguration.
#        Dient als Basis für alle neuen Targets.

set -euo pipefail

# --- CONFIGURATION & GLOBALS ---
readonly SCRIPT_NAME="config_module.sh"
readonly BUILD_CACHE_DIR="${BUILD_CACHE_DIR:-/build-cache}"
readonly HARDWARE_CONFIG_FILE="${HARDWARE_CONFIG_FILE:-${BUILD_CACHE_DIR}/target_hardware_config.txt}"
readonly OUTPUT_TOOLCHAIN_FILE="${OUTPUT_TOOLCHAIN_FILE:-${BUILD_CACHE_DIR}/cross_compile_toolchain.cmake}"
readonly OUTPUT_CONFIG_FILE="${OUTPUT_CONFIG_FILE:-${BUILD_CACHE_DIR}/build_config.sh}"
readonly LOG_LEVEL="${LOG_LEVEL:-INFO}"

# Hardware-Konfiguration
declare -A HW_CONFIG
declare -A COMPILER_CONFIG

# --- LOGGING ---
log_info() { echo "ℹ️  [$(date '+%H:%M:%S')] [CONFIG] $1"; }
log_success() { echo "✅ [$(date '+%H:%M:%S')] [CONFIG] $1"; }
log_warn() { echo "⚠️  [$(date '+%H:%M:%S')] [CONFIG] $1"; }
log_error() { echo "❌ [$(date '+%H:%M:%S')] [CONFIG] $1" >&2; }

die() { log_error "$1"; exit 1; }
trap "die 'Config Module fehlgeschlagen'" ERR

# ============================================================================
# HARDWARE CONFIG PARSING
# ============================================================================

load_hardware_config() {
    log_info "Lade Hardware-Konfiguration: $HARDWARE_CONFIG_FILE"
    
    if [[ ! -f "$HARDWARE_CONFIG_FILE" ]]; then
        log_warn "Hardware-Konfigurationsdatei nicht gefunden."
        log_warn "Verwende Defaults für Template (Generic AArch64)."
        # Defaults für das Template
        HW_CONFIG[ARCHITECTURE_FULL]="aarch64"
        HW_CONFIG[CPU_MODEL_NAME]="generic"
        return 0
    fi
    
    # Parse File
    while IFS='=' read -r key value; do
        [[ "$key" =~ ^[[:space:]]*# ]] && continue
        [[ -z "$key" ]] && continue
        key=$(echo "$key" | tr -d ' \t')
        value=$(echo "$value" | tr -d ' \t' | sed 's/^"//;s/"$//')
        HW_CONFIG["$key"]="$value"
    done < <(grep -E '^[^#]*=' "$HARDWARE_CONFIG_FILE")
}

# ============================================================================
# COMPILER FLAGS GENERATION
# ============================================================================

generate_compiler_flags() {
    log_info "Generiere Compiler-Flags..."
    
    # Standard Flags für Release Builds
    local cflags="-O3 -pthread -fPIC"
    local cxxflags="-std=c++17"
    local cmake_flags="-DGGML_NATIVE=ON" # Standard für Native Build, wird beim Cross-Compile überschrieben
    local build_jobs=$(nproc)
    
    # --- ARCHITEKTUR LOGIK (Template: AArch64 Default) ---
    if [[ "${HW_CONFIG[ARCHITECTURE_FULL]}" == "aarch64" ]]; then
        COMPILER_CONFIG[CROSS_PREFIX]="aarch64-linux-gnu"
        
        # CPU Spezifische Optimierungen (Beispielhaft)
        if [[ "${HW_CONFIG[CPU_MODEL_NAME]}" =~ "Cortex-A" ]]; then
             # Wenn wir den genauen Core kennen, könnten wir hier tunen
             # cflags="$cflags -mcpu=native" # Nur wenn nativ kompiliert wird!
             :
        fi
        
        # NEON Support
        if [[ "${HW_CONFIG[SUPPORTS_NEON]:-OFF}" == "ON" ]]; then
            cmake_flags="$cmake_flags -DGGML_NEON=ON"
        fi
    fi
    
    # Speichere Konfiguration
    COMPILER_CONFIG[CFLAGS]="$cflags"
    COMPILER_CONFIG[CXXFLAGS]="$cxxflags $cflags"
    COMPILER_CONFIG[CMAKE_FLAGS]="$cmake_flags"
    COMPILER_CONFIG[BUILD_JOBS]="$build_jobs"
}

# ============================================================================
# CMAKE TOOLCHAIN GENERATION
# ============================================================================

generate_cmake_toolchain() {
    log_info "Generiere CMake Toolchain: $OUTPUT_TOOLCHAIN_FILE"
    
    # CCACHE Detection
    local ccache_path=$(which ccache || echo "")
    
    cat > "$OUTPUT_TOOLCHAIN_FILE" << EOF
# CMake Toolchain File
# Generated by $SCRIPT_NAME
# Target: ${HW_CONFIG[CPU_MODEL_NAME]:-Unknown}

SET(CMAKE_SYSTEM_NAME Linux)
SET(CMAKE_SYSTEM_PROCESSOR ${HW_CONFIG[ARCHITECTURE_FULL]})
EOF

    # Cross-Compile Pfade (falls definiert)
    if [[ -n "${COMPILER_CONFIG[CROSS_PREFIX]:-}" ]]; then
        cat >> "$OUTPUT_TOOLCHAIN_FILE" << EOF
SET(CMAKE_C_COMPILER   /usr/bin/${COMPILER_CONFIG[CROSS_PREFIX]}-gcc)
SET(CMAKE_CXX_COMPILER /usr/bin/${COMPILER_CONFIG[CROSS_PREFIX]}-g++)
SET(CMAKE_AR           /usr/bin/${COMPILER_CONFIG[CROSS_PREFIX]}-ar)
SET(CMAKE_STRIP        /usr/bin/${COMPILER_CONFIG[CROSS_PREFIX]}-strip)
EOF
    fi

    # CCACHE Integration
    if [[ -n "$ccache_path" ]]; then
        cat >> "$OUTPUT_TOOLCHAIN_FILE" << EOF

# CCACHE Configuration
SET(CMAKE_C_COMPILER_LAUNCHER "$ccache_path")
SET(CMAKE_CXX_COMPILER_LAUNCHER "$ccache_path")
EOF
        log_info "CCACHE aktiviert: $ccache_path"
    fi

    # Flags
    cat >> "$OUTPUT_TOOLCHAIN_FILE" << EOF

# Compiler Flags
SET(CMAKE_C_FLAGS   "\${CMAKE_C_FLAGS} ${COMPILER_CONFIG[CFLAGS]}")
SET(CMAKE_CXX_FLAGS "\${CMAKE_CXX_FLAGS} ${COMPILER_CONFIG[CXXFLAGS]}")

# llama.cpp optimizations
${COMPILER_CONFIG[CMAKE_FLAGS]}

SET(CMAKE_BUILD_TYPE Release)
EOF
    log_success "CMake Toolchain generiert"
}

# ============================================================================
# BUILD CONFIG SCRIPT GENERATION
# ============================================================================

generate_build_config() {
    log_info "Generiere Build Config Script..."
    cat > "$OUTPUT_CONFIG_FILE" << EOF
#!/bin/bash
export TARGET_ARCH="${HW_CONFIG[ARCHITECTURE_FULL]}"
export CFLAGS="${COMPILER_CONFIG[CFLAGS]}"
export CXXFLAGS="${COMPILER_CONFIG[CXXFLAGS]}"
export CMAKE_TOOLCHAIN_FILE="$OUTPUT_TOOLCHAIN_FILE"
export BUILD_JOBS="${COMPILER_CONFIG[BUILD_JOBS]}"
echo "Build configuration loaded."
EOF
    chmod +x "$OUTPUT_CONFIG_FILE"
}

# ============================================================================
# MAIN
# ============================================================================
main() {
    local start_time=$SECONDS
    log_info "Starte Config Module (Hardware-Agent)..."
    
    # Parse Args
    while [[ $# -gt 0 ]]; do
        case $1 in
            --hardware-config) HARDWARE_CONFIG_FILE="$2"; shift 2;;
            *) shift ;;
        esac
    done
    
    load_hardware_config
    generate_compiler_flags
    generate_cmake_toolchain
    generate_build_config
    
    local duration=$((SECONDS - start_time))
    log_success "Config Module abgeschlossen in ${duration}s"
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi

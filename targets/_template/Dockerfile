# Dockerfile Template for [MODULE_NAME]
# Generated by LLM Cross-Compiler Framework
# Target Architecture: [IHRE_ARCHITEKTUR]
# DIREKTIVE: Goldstandard, Multi-stage, Hadolint-konform, Secured, CI-Ready

# ============================================================================
# STAGE 1: Build Environment
# ============================================================================
FROM debian:bookworm-slim AS builder

LABEL maintainer="[Hersteller]"
LABEL description="[Hardware-Familie] Cross-Compilation Container"
LABEL target.architecture="[IHRE_ARCHITEKTUR]"

# CI/CD Build Args for User Mapping
ARG USER_ID=1000
ARG GROUP_ID=1000
ARG BUILD_JOBS=4
ARG PYTHON_VERSION=3.11

ENV DEBIAN_FRONTEND=noninteractive
ENV LLAMA_CPP_PATH=/usr/src/llama.cpp
ENV BUILD_CACHE_DIR=/build-cache
ENV PATH="/root/.local/bin:$PATH"

# System Dependencies
# {packages_str} will be replaced by the wizard with target specific packages
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        build-essential cmake make git curl wget ca-certificates \
        python3 python3-pip python3-dev python3-venv \
        pkg-config libffi-dev libssl-dev jq bc file time ccache \
        {packages_str} \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Python Environment Setup
RUN python3 -m pip install --no-cache-dir --upgrade pip setuptools wheel

# Install CPU-only PyTorch to save space (approx. 2GB saved vs CUDA version)
RUN python3 -m pip install --no-cache-dir \
        torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu

# Install Framework Dependencies
RUN python3 -m pip install --no-cache-dir \
        transformers tokenizers safetensors sentencepiece protobuf \
        huggingface-hub datasets numpy scipy onnx onnxruntime \
        tqdm psutil pyyaml requests

# ============================================================================
# STAGE 2: Runtime Environment
# ============================================================================
FROM debian:bookworm-slim AS runtime

LABEL stage="runtime"

ENV DEBIAN_FRONTEND=noninteractive
ENV BUILD_CACHE_DIR=/build-cache
ENV PATH="/app/modules:/app/scripts:${PATH}"

# Runtime Dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        python3 python3-pip cmake make git bc jq file curl \
    && rm -rf /var/lib/apt/lists/* && apt-get clean

# Copy Python Environment from Builder
# Adjust python version path if base image changes!
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

# Setup Directories & User with correct UID/GID
RUN groupadd -g ${GROUP_ID} llmbuilder && \
    useradd -u ${USER_ID} -g llmbuilder -d /app -s /bin/bash llmbuilder && \
    mkdir -p ${BUILD_CACHE_DIR}/{models,temp,output,logs,toolchains} && \
    chown -R llmbuilder:llmbuilder /app ${BUILD_CACHE_DIR}

WORKDIR /app
COPY modules/ ./modules/
COPY scripts/ ./scripts/
RUN chmod +x modules/*.sh scripts/*.sh

# Setup Entrypoint
COPY --chown=llmbuilder:llmbuilder docker/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

WORKDIR ${BUILD_CACHE_DIR}
USER llmbuilder

VOLUME ["${BUILD_CACHE_DIR}"]

ENTRYPOINT ["/entrypoint.sh"]
CMD ["interactive"]

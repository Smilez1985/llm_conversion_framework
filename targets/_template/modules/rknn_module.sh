#!/bin/bash
# rknn_module.sh Template
# Generated by LLM Cross-Compiler Framework
#
# ZWECK: Vorlage für die Integration von RKNN-Toolkit2 (NPU) für Voice/Vision Modelle.
# Dieses Skript wird vom 'build.sh' Dispatcher aufgerufen, wenn Task != LLM ist.

set -euo pipefail

# ============================================================================
# CONFIGURATION
# ============================================================================

# Environment Variables injected by build.sh
# $MODEL_SOURCE: Path to input model (file or dir)
# $QUANTIZATION: Target quantization (i8, fp16)
# $OUTPUT_DIR:   Destination for artifacts
# $SCRIPT_DIR:   Path to helper scripts

BUILD_CACHE_DIR="${BUILD_CACHE_DIR:-/build-cache}"
OUTPUT_DIR="${OUTPUT_DIR:-${BUILD_CACHE_DIR}/output}"
SCRIPT_DIR="${SCRIPT_DIR:-/app/scripts}"

log_info() { echo ">> [RKNN-Template] $(date '+%H:%M:%S') INFO: $1"; }
log_error() { echo ">> [RKNN-Template] $(date '+%H:%M:%S') ERROR: $1" >&2; }
die() { log_error "$1"; exit 1; }

# ============================================================================
# MAIN LOGIC
# ============================================================================

main() {
    log_info "Initializing RKNN Module..."
    
    # 1. Input Validierung
    if [[ -z "${MODEL_SOURCE:-}" || "$MODEL_SOURCE" == "none" ]]; then
        log_info "No model source provided. Skipping RKNN conversion."
        exit 0
    fi

    log_info "Model: $MODEL_SOURCE"
    log_info "Quant: ${QUANTIZATION:-None}"
    
    # 2. Quantization Mapping
    # Maps Framework types to RKNN Python API types ('i8', 'fp16')
    case "${QUANTIZATION:-i8}" in
        "INT8"|"i8"|"Q8_0"|"w8a8") 
            Q_TYPE="i8"
            ;;
        "FP16"|"f16") 
            Q_TYPE="fp16"
            ;;
        *) 
            log_info "Unknown quantization '$QUANTIZATION'. Defaulting to 'i8' (INT8)."
            Q_TYPE="i8"
            ;;
    esac

    # 3. Check for Python Converter Script
    # Das Skript muss zur Build-Zeit nach /app/scripts kopiert worden sein
    CONVERTER="$SCRIPT_DIR/rknn_converter.py"
    
    if [ ! -f "$CONVERTER" ]; then
        die "Critical: Python converter script not found at $CONVERTER. Ensure it is present in the Docker image."
    fi
    
    # 4. Prepare Output Path
    MODEL_NAME=$(basename "$MODEL_SOURCE")
    # Remove extension for cleaner output name
    MODEL_NAME="${MODEL_NAME%.*}"
    
    # Target Platform (kann via Env oder Config gesetzt sein, default rk3566 für Templates)
    TARGET_PLATFORM="${TARGET_BOARD:-rk3566}"
    
    OUTPUT_FILE="$OUTPUT_DIR/${MODEL_NAME}_${TARGET_PLATFORM}_${Q_TYPE}.rknn"

    # 5. Execute Conversion
    log_info "Delegating to Python Converter..."
    log_info "  - Target: $TARGET_PLATFORM"
    log_info "  - Dtype:  $Q_TYPE"
    log_info "  - Input:  $MODEL_SOURCE"
    
    set +e
    python3 "$CONVERTER" \
        --model "$MODEL_SOURCE" \
        --output "$OUTPUT_FILE" \
        --target "$TARGET_PLATFORM" \
        --dtype "$Q_TYPE"
    
    EXIT_CODE=$?
    set -e
    
    # 6. Validation & Metadata
    if [ $EXIT_CODE -eq 0 ]; then
        if [ -f "$OUTPUT_FILE" ]; then
            SIZE=$(du -h "$OUTPUT_FILE" | cut -f1)
            log_info "✅ Success! Artifact created: $OUTPUT_FILE ($SIZE)"
            
            # Metadaten für Deployment
            echo "framework=rknn" > "$OUTPUT_DIR/${MODEL_NAME}.meta"
            echo "quantization=$Q_TYPE" >> "$OUTPUT_DIR/${MODEL_NAME}.meta"
            echo "platform=$TARGET_PLATFORM" >> "$OUTPUT_DIR/${MODEL_NAME}.meta"
        else
            die "Python script reported success, but output file '$OUTPUT_FILE' is missing."
        fi
    else
        die "Python conversion failed with exit code $EXIT_CODE. Check logs above."
    fi
    
    log_info "Template execution finished."
}

main "$@"
